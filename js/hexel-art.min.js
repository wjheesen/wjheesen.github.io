"use strict";function _classCallCheck(e,o){if(!(e instanceof o))throw new TypeError("Cannot call a class as a function")}function checkRender(){(surface.resize()||renderer.needToRender)&&(renderer.needToRender=!1,renderer.onDrawFrame()),requestAnimationFrame(checkRender)}function onDown(e){switch(e.altKey&&(color.setRandom(),$(colorPicker).val(color.toHexString())),e.which){case 1:tool=Tools[$(toolPicker).val()];break;case 2:tool=panTool;break;case 3:tool=null}tool&&tool.handleDownAction(e)}function onDrag(e){tool&&tool.handleDragAction(e)}function applyColorChanges(){renderer.applyColorChanges()}function updateCout(){for(var e=ctx.getImageData(0,0,100,100),o=e.data,n=0,a=cout.width-1;a>=0;a--)for(var r=0;r<cout.height;r++){var t=4*(cout.width*a+r),c=layout.hexes[n++];if(-1===c.color)o[t]=0,o[t+1]=0,o[t+2]=0,o[t+3]=0;else{var i=ghx.Color.fromHex(c.color);o[t]=i.r,o[t+1]=i.g,o[t+2]=i.b,o[t+3]=255}}ctx.clearRect(0,0,cout.width,cout.height),ctx.putImageData(e,0,0)}function downloadCanvas(e,o,n){e.href=o.toDataURL(),e.download=n}function onUp(e){}function onOut(e){}function handleScroll(e){e.preventDefault(),e.stopPropagation();var o=e.detail<0||e.wheelDelta>0,n=o?1.5:.666666,a=renderer.projection.scale,r=a*n;MIN_SCALE>r?(n=MIN_SCALE/a,a=MIN_SCALE):r>MAX_SCALE?(n=MAX_SCALE/a,a=MAX_SCALE):a=r,renderer.projection.scale=a;var t=renderer.projection.offset,c=surface.screenToClip(e),i=ghx.Vec2.from(t,c);i.mulScalar((n-1)/n),t.add(i),constrainPointToGrid(t),renderer.applyProjectionChanges()}function constrainPointToGrid(e){var o=renderer.projection.scale,n=(o-MIN_SCALE)/o,a=layout.bounds.right*n,r=layout.bounds.top*n;e.x=constrain(e.x,-a,a),e.y=constrain(e.y,-r,r)}function constrain(e,o,n){return o>e?o:e>n?n:e}var ghx=exports,cout=document.getElementById("cout"),ctx=cout.getContext("2d"),canvas=document.getElementById("c"),gl=twgl.getWebGLContext(canvas),grid=new ghx.RectangleGrid(ghx.Orientation.PointyTop,100,100),layout=new ghx.Layout(grid),renderer=new ghx.Renderer(gl,layout),surface=new ghx.Surface(canvas,renderer);checkRender();var colorPicker=$("#color-picker"),color=ghx.Color.fromHexString($(colorPicker).val());$(colorPicker).change(function(){color.setHexString($(this).val())});var Tool=function e(o,n){_classCallCheck(this,e),this.handleDownAction=o,this.handleDragAction=n},panTool=new Tool;panTool.handleDownAction=function(e){this.previous=surface.screenToClip(e),console.log(this.previous)},panTool.handleDragAction=function(e){var o=surface.screenToClip(e),n=ghx.Vec2.from(o,this.previous),a=renderer.projection.offset;a.add(n),constrainPointToGrid(a),renderer.applyProjectionChanges(),this.previous.x=o.x+n.x,this.previous.y=o.y+n.y};var brush=new Tool;brush.handleDownAction=function(e){},brush.handleDragAction=function(e){var o=surface.screenToClip(e),n=layout.indexOfHexContaining(o);-1!==n&&(layout.fillRange(n,brushSize,color),applyColorChanges())};var eraser=new Tool;eraser.handleDownAction=function(e){},eraser.handleDragAction=function(e){var o=surface.screenToClip(e),n=layout.indexOfHexContaining(o);-1!==n&&(layout.eraseRange(n,brushSize),applyColorChanges())};var paintBucket=new Tool;paintBucket.handleDownAction=function(e){var o=surface.screenToClip(e),n=layout.indexOfHexContaining(o);-1!==n&&(layout.floodFill(n,color),applyColorChanges())},paintBucket.handleDragAction=function(e){};var eyedropper=new Tool;eyedropper.handleDownAction=function(e){var o=surface.screenToClip(e),n=layout.indexOfHexContaining(o);-1!=n&&(color.setColor(layout.getHexagonColor(n)),$(colorPicker).val(color.toHexString()))},eyedropper.handleDragAction=function(e){};var lineTool=new Tool;lineTool.handleDownAction=function(e){var o=surface.screenToClip(e);this.start=layout.clipToCube(o),this.changes=new ghx.Changes},lineTool.handleDragAction=function(e){layout.reverseChanges(this.changes);var o=surface.screenToClip(e),n=layout.clipToCube(o);layout.addLine(this.start,n,brushSize,color,this.changes),applyColorChanges()};var rectangleTool=new Tool;rectangleTool.handleDownAction=function(e){this.start=surface.screenToClip(e),this.changes=new ghx.Changes},rectangleTool.handleDragAction=function(e){layout.reverseChanges(this.changes);var o=surface.screenToClip(e),n=ghx.Rect.fromTwoPoints(this.start,o);layout.addRect(n,color,this.changes),applyColorChanges()};var Meshes=[ghx.Mesh.nGon(3),ghx.Mesh.nStar(2,.5,1),ghx.Mesh.nGon(5),ghx.Mesh.nGon(6),ghx.Mesh.nGon(40),ghx.Mesh.nStar(5,.4,1),ghx.Mesh.heart(),ghx.Mesh.flower(),ghx.Mesh.bat()],shapePicker=$("#shape-picker"),mesh=Meshes[$(shapePicker).val()];$(shapePicker).change(function(){mesh=Meshes[$(this).val()]});var shapeTool=new Tool;shapeTool.handleDownAction=function(e){this.changes=new ghx.Changes,this.start=surface.screenToClip(e),this.shape=new ghx.Shape(mesh)},shapeTool.handleDragAction=function(e){layout.reverseChanges(this.changes);var o=surface.screenToClip(e);this.shape.setEndPoints(this.start,o),layout.addShape(this.shape,color,this.changes),applyColorChanges()};var Tools=[brush,eraser,paintBucket,eyedropper,lineTool,rectangleTool,shapeTool],toolPicker=$("#tool-picker"),tool=Tools[$(toolPicker).val()];$(toolPicker).change(function(){tool=Tools[$(this).val()]});var brushSizePicker=$("#brush-size-picker"),brushSize=$(brushSizePicker).val()-1;$(brushSizePicker).change(function(){brushSize=$(brushSizePicker).val()-1}),$("#download").click(function(){updateCout(),downloadCanvas(this,cout,"hexel-art.png")});var detector=new ghx.DragDetector(canvas,onDown,onDrag,onUp,onOut),MIN_SCALE=1,MAX_SCALE=Math.max(grid.rows,grid.cols);canvas.addEventListener("DOMMouseScroll",handleScroll,!1),canvas.addEventListener("mousewheel",handleScroll,!1),$("#image-picker").change(function(e){var o=new FileReader;o.onload=function(e){var o=new Image;o.onload=function(){var e=cout.width/o.width,n=cout.height/o.height,a=Math.min(e,n),r=(cout.width-o.width*a)/2,t=(cout.height-o.height*a)/2;ctx.clearRect(0,0,cout.width,cout.height),ctx.drawImage(o,0,0,o.width,o.height,r,t,o.width*a,o.height*a);for(var c=ctx.getImageData(0,0,100,100).data,i=0,l=cout.width-1;l>=0;l--)for(var s=0;s<cout.height;s++){var h=4*(cout.width*l+s);if(0!==c[h+3]){var u=new ghx.Color(c[h],c[h+1],c[h+2]);layout.setHexagonColor(i,u)}i++}applyColorChanges()},o.src=e.target.result},o.readAsDataURL(e.target.files[0])});